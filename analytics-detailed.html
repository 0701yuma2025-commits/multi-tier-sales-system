<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è©³ç´°åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - å¤šæ®µéšå–¶æ¥­ä»£ç†åº—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="js/auth-check-simple.js"></script>
    
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@2.0.1/dist/chartjs-chart-matrix.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/common-functions.js"></script>
    <script src="js/analytics-supabase.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f3f4f6;
            min-height: 100vh;
        }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background-color: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            font-size: 24px;
            color: #1f2937;
        }
        
        .header-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .date-range-selector {
            display: flex;
            gap: 8px;
            align-items: center;
            background-color: #f3f4f6;
            padding: 8px 12px;
            border-radius: 8px;
        }
        
        .date-input {
            border: none;
            background: transparent;
            font-size: 14px;
            color: #4b5563;
            cursor: pointer;
        }
        
        .back-btn {
            padding: 8px 16px;
            background-color: #6366f1;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
        }
        
        .back-btn:hover {
            background-color: #4f46e5;
        }
        
        /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .filters-section {
            background-color: white;
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .filter-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
        }
        
        .filter-select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background-color: white;
            font-size: 14px;
            color: #1f2937;
            cursor: pointer;
        }
        
        .apply-filters-btn {
            padding: 8px 20px;
            background-color: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            align-self: flex-end;
            margin-left: auto;
        }
        
        .apply-filters-btn:hover {
            background-color: #059669;
        }
        
        /* ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚«ãƒ¼ãƒ‰ */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            padding: 24px;
        }
        
        .metric-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .metric-label {
            color: #6b7280;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
        }
        
        .metric-comparison {
            font-size: 12px;
            margin-top: 4px;
        }
        
        .metric-comparison.positive {
            color: #10b981;
        }
        
        .metric-comparison.negative {
            color: #ef4444;
        }
        
        /* ãƒãƒ£ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠ */
        .charts-container {
            padding: 0 24px 24px;
        }
        
        .chart-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .chart-options {
            display: flex;
            gap: 8px;
        }
        
        .chart-btn {
            padding: 6px 12px;
            background-color: #f3f4f6;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .chart-btn.active {
            background-color: #6366f1;
            color: white;
        }
        
        .chart-wrapper {
            position: relative;
            height: 400px;
        }
        
        .chart-wrapper.small {
            height: 300px;
        }
        
        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        .table-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
        }
        
        .table-wrapper {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid #e5e7eb;
            color: #4b5563;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
            color: #1f2937;
            font-size: 14px;
        }
        
        .comparison-tables {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 24px;
        }
        
        /* ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚«ãƒ¼ãƒ‰ */
        .insights-section {
            padding: 0 24px 24px;
        }
        
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 16px;
        }
        
        .insight-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #6366f1;
        }
        
        .insight-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .insight-icon {
            font-size: 20px;
        }
        
        .insight-content {
            color: #4b5563;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .insight-action {
            margin-top: 12px;
            color: #6366f1;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .insight-action:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="header">
        <h1>ğŸ“Š è©³ç´°åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
        <div class="header-controls">
            <div class="date-range-selector">
                <input type="date" class="date-input" id="startDate" value="2024-02-01">
                <span>ã€œ</span>
                <input type="date" class="date-input" id="endDate" value="2024-03-31">
            </div>
            <a href="dashboard-admin.html" class="back-btn">â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</a>
        </div>
    </header>
    
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <nav style="background-color: white; border-bottom: 1px solid #e5e7eb; padding: 0 24px;">
        <ul style="display: flex; list-style: none; gap: 32px; margin: 0; padding: 0;">
            <li style="padding: 16px 0; color: #6b7280; font-size: 15px; cursor: pointer;" onclick="location.href='/dashboard-admin.html'">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</li>
            <li style="padding: 16px 0; color: #3b82f6; font-weight: 500; font-size: 15px; cursor: pointer; position: relative;">ğŸ—’ï¸ è©³ç´°åˆ†æ<span style="position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background-color: #3b82f6;"></span></li>
            <li style="padding: 16px 0; color: #6b7280; font-size: 15px; cursor: pointer;" onclick="location.href='/agencies-admin.html'">ä»£ç†åº—ç®¡ç†</li>
            <li style="padding: 16px 0; color: #6b7280; font-size: 15px; cursor: pointer;" onclick="location.href='/sales-functions.html'">å£²ä¸Šç®¡ç†</li>
            <li style="padding: 16px 0; color: #6b7280; font-size: 15px; cursor: pointer;" onclick="location.href='/commissions-admin.html'">å ±é…¬ç®¡ç†</li>
        </ul>
    </nav>
    
    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="filters-section">
        <div class="filter-group">
            <label class="filter-label">ä»£ç†åº—éšå±¤</label>
            <select class="filter-select">
                <option value="">ã™ã¹ã¦</option>
                <option value="1">Tier 1</option>
                <option value="2">Tier 2</option>
                <option value="3">Tier 3</option>
                <option value="4">Tier 4</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label class="filter-label">åœ°åŸŸ</label>
            <select class="filter-select">
                <option value="">ã™ã¹ã¦</option>
                <option value="kanto">é–¢æ±</option>
                <option value="kansai">é–¢è¥¿</option>
                <option value="chubu">ä¸­éƒ¨</option>
                <option value="tohoku">æ±åŒ—</option>
                <option value="kyushu">ä¹å·</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label class="filter-label">å•†å“ã‚«ãƒ†ã‚´ãƒª</label>
            <select class="filter-select">
                <option value="">ã™ã¹ã¦</option>
                <option value="premium">ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³</option>
                <option value="standard">ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ—ãƒ©ãƒ³</option>
                <option value="basic">ãƒ™ãƒ¼ã‚·ãƒƒã‚¯ãƒ—ãƒ©ãƒ³</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label class="filter-label">ä»£ç†åº—è¦æ¨¡</label>
            <select class="filter-select">
                <option value="">ã™ã¹ã¦</option>
                <option value="large">å¤§è¦æ¨¡ï¼ˆæœˆå•†500ä¸‡å††ä»¥ä¸Šï¼‰</option>
                <option value="medium">ä¸­è¦æ¨¡ï¼ˆæœˆå•†100-500ä¸‡å††ï¼‰</option>
                <option value="small">å°è¦æ¨¡ï¼ˆæœˆå•†100ä¸‡å††æœªæº€ï¼‰</option>
            </select>
        </div>
        
        <button class="apply-filters-btn" onclick="applyFilters()">ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨</button>
    </div>
    
    <!-- ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚«ãƒ¼ãƒ‰ -->
    <div class="metrics-grid" id="metricsGrid">
        <div class="metric-card">
            <div class="metric-label">å¹³å‡å¥‘ç´„å˜ä¾¡</div>
            <div class="metric-value">-</div>
            <div class="metric-comparison">-</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-label">LTVï¼ˆé¡§å®¢ç”Ÿæ¶¯ä¾¡å€¤ï¼‰</div>
            <div class="metric-value">-</div>
            <div class="metric-comparison">-</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-label">é¡§å®¢ç²å¾—ã‚³ã‚¹ãƒˆï¼ˆCACï¼‰</div>
            <div class="metric-value">-</div>
            <div class="metric-comparison">-</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-label">ç¶™ç¶šç‡</div>
            <div class="metric-value">-</div>
            <div class="metric-comparison">-</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-label">ROI</div>
            <div class="metric-value">-</div>
            <div class="metric-comparison">-</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-label">ãƒªãƒ¼ãƒ‰â†’æˆç´„ç‡</div>
            <div class="metric-value">-</div>
            <div class="metric-comparison">-</div>
        </div>
    </div>
    
    <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div id="supabaseError" style="display: none; background-color: #FEF2F2; border: 1px solid #FECACA; border-radius: 8px; padding: 16px; margin: 24px; color: #991B1B;">
        <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600;">âš ï¸ SupabaseãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</h3>
        <p style="margin: 0; font-size: 14px;">è©³ç´°åˆ†ææ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€Supabaseç’°å¢ƒå¤‰æ•°ã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚</p>
        <p style="margin: 8px 0 0 0; font-size: 12px; color: #7F1D1D;">è¨­å®šæ–¹æ³•ï¼šãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€VITE_SUPABASE_URLã¨VITE_SUPABASE_ANON_KEYã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
    </div>
    
    <!-- ãƒãƒ£ãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="charts-container">
        <!-- ã‚³ãƒ›ãƒ¼ãƒˆåˆ†æ -->
        <div class="chart-section">
            <div class="chart-header">
                <h2 class="chart-title">ã‚³ãƒ›ãƒ¼ãƒˆåˆ†æ - ä»£ç†åº—ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</h2>
                <div class="chart-options">
                    <button class="chart-btn active" onclick="switchCohortView('revenue')">å£²ä¸Š</button>
                    <button class="chart-btn" onclick="switchCohortView('retention')">ç¶™ç¶šç‡</button>
                    <button class="chart-btn" onclick="switchCohortView('growth')">æˆé•·ç‡</button>
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="cohortChart"></canvas>
            </div>
        </div>
        
        
        <!-- ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ— -->
        <div class="chart-section">
            <div class="chart-header">
                <h2 class="chart-title">æ™‚é–“åˆ¥å£²ä¸Šãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</h2>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="heatmapMetric" onchange="updateHeatmapChart()" style="padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                        <option value="sales">å£²ä¸Šé‡‘é¡</option>
                        <option value="count">å–å¼•ä»¶æ•°</option>
                        <option value="average">å¹³å‡å˜ä¾¡</option>
                    </select>
                    <button onclick="exportHeatmap()" style="padding: 6px 12px; background: #6b7280; color: white; border: none; border-radius: 6px; font-size: 13px; cursor: pointer;">ğŸ“¥ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="heatmapChart"></canvas>
            </div>
            <div style="display: flex; gap: 20px; justify-content: center; margin-top: 16px; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: #6b7280;">
                    <div style="width: 20px; height: 10px; background: #f3f4f6; border-radius: 2px;"></div>
                    <span>ä½</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: #6b7280;">
                    <div style="width: 20px; height: 10px; background: #fef3c7; border-radius: 2px;"></div>
                    <span>ä¸­ä½</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: #6b7280;">
                    <div style="width: 20px; height: 10px; background: #fbbf24; border-radius: 2px;"></div>
                    <span>ä¸­</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: #6b7280;">
                    <div style="width: 20px; height: 10px; background: #f59e0b; border-radius: 2px;"></div>
                    <span>ä¸­é«˜</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: #6b7280;">
                    <div style="width: 20px; height: 10px; background: #dc2626; border-radius: 2px;"></div>
                    <span>é«˜</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ¯”è¼ƒãƒ†ãƒ¼ãƒ–ãƒ« -->
    <div class="comparison-tables">
        <div class="table-section">
            <div class="chart-header">
                <h2 class="chart-title">ãƒˆãƒƒãƒ—ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ¼åˆ†æ</h2>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>ä»£ç†åº—å</th>
                            <th>æœˆé–“å£²ä¸Š</th>
                            <th>æˆç´„ç‡</th>
                            <th>æˆé•·ç‡</th>
                            <th>åŠ¹ç‡ã‚¹ã‚³ã‚¢</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>ABCå•†äº‹</td>
                            <td>Â¥3,250,000</td>
                            <td>23.5%</td>
                            <td><span style="color: #10b981;">+45%</span></td>
                            <td>94/100</td>
                        </tr>
                        <tr>
                            <td>XYZã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ã‚·ãƒ¼</td>
                            <td>Â¥2,890,000</td>
                            <td>21.2%</td>
                            <td><span style="color: #10b981;">+38%</span></td>
                            <td>91/100</td>
                        </tr>
                        <tr>
                            <td>å±±ç”°å–¶æ¥­ä¼ç”»</td>
                            <td>Â¥2,450,000</td>
                            <td>19.8%</td>
                            <td><span style="color: #10b981;">+32%</span></td>
                            <td>88/100</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="table-section">
            <div class="chart-header">
                <h2 class="chart-title">å•†å“åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</h2>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>å•†å“ã‚«ãƒ†ã‚´ãƒª</th>
                            <th>è²©å£²æ•°</th>
                            <th>å£²ä¸Šè²¢çŒ®åº¦</th>
                            <th>åˆ©ç›Šç‡</th>
                            <th>ãƒˆãƒ¬ãƒ³ãƒ‰</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³</td>
                            <td>124</td>
                            <td>45.2%</td>
                            <td>38.5%</td>
                            <td><span style="color: #10b981;">â†‘</span></td>
                        </tr>
                        <tr>
                            <td>ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ—ãƒ©ãƒ³</td>
                            <td>298</td>
                            <td>35.8%</td>
                            <td>32.1%</td>
                            <td><span style="color: #f59e0b;">â†’</span></td>
                        </tr>
                        <tr>
                            <td>ãƒ™ãƒ¼ã‚·ãƒƒã‚¯ãƒ—ãƒ©ãƒ³</td>
                            <td>456</td>
                            <td>19.0%</td>
                            <td>28.3%</td>
                            <td><span style="color: #ef4444;">â†“</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="insights-section">
        <h2 style="font-size: 20px; font-weight: 600; color: #1f2937; margin-bottom: 16px;">AIã«ã‚ˆã‚‹åˆ†æã‚¤ãƒ³ã‚µã‚¤ãƒˆ</h2>
        <div class="insights-grid">
            <div class="insight-card">
                <div class="insight-title">
                    <span class="insight-icon">ğŸ’¡</span>
                    æˆé•·æ©Ÿä¼šã®ç™ºè¦‹
                </div>
                <div class="insight-content">
                    é–¢æ±ã‚¨ãƒªã‚¢ã®Tier 2ä»£ç†åº—ãŒéå»3ãƒ¶æœˆã§å¹³å‡35%ã®æˆé•·ã‚’é”æˆã€‚ç‰¹ã«ä¸­å°ä¼æ¥­å‘ã‘ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒåŠ¹æœçš„ã§ã™ã€‚
                </div>
                <div class="insight-action">è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’è¦‹ã‚‹ â†’</div>
            </div>
            
            <div class="insight-card">
                <div class="insight-title">
                    <span class="insight-icon">âš ï¸</span>
                    æ”¹å–„ãŒå¿…è¦ãªã‚¨ãƒªã‚¢
                </div>
                <div class="insight-content">
                    ãƒ™ãƒ¼ã‚·ãƒƒã‚¯ãƒ—ãƒ©ãƒ³ã®ç¶™ç¶šç‡ãŒå‰æœˆæ¯”ã§5%ä½ä¸‹ã€‚ä¾¡æ ¼ç«¶äº‰åŠ›ã®è¦‹ç›´ã—ã¾ãŸã¯ä»˜åŠ ä¾¡å€¤ã®è¿½åŠ ãŒæ¨å¥¨ã•ã‚Œã¾ã™ã€‚
                </div>
                <div class="insight-action">æ”¹å–„è¨ˆç”»ã‚’ä½œæˆ â†’</div>
            </div>
            
            <div class="insight-card">
                <div class="insight-title">
                    <span class="insight-icon">ğŸ¯</span>
                    ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹äºˆæ¸¬
                </div>
                <div class="insight-content">
                    ç¾åœ¨ã®ãƒˆãƒ¬ãƒ³ãƒ‰ãŒç¶šã‘ã°ã€Q2ã®å£²ä¸Šã¯å‰å¹´æ¯”+28%ã€ç·å ±é…¬é¡ã¯+32%ã®æˆé•·ãŒè¦‹è¾¼ã¾ã‚Œã¾ã™ã€‚
                </div>
                <div class="insight-action">äºˆæ¸¬è©³ç´°ã‚’ç¢ºèª â†’</div>
            </div>
            
            <div class="insight-card">
                <div class="insight-title">
                    <span class="insight-icon">ğŸ”</span>
                    ç•°å¸¸å€¤ã®æ¤œå‡º
                </div>
                <div class="insight-content">
                    ä¹å·ã‚¨ãƒªã‚¢ã§é€šå¸¸ã®3å€ã®æ–°è¦ç™»éŒ²ãŒç™ºç”Ÿã€‚åœ°åŸŸã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®åŠ¹æœæ¸¬å®šã¨æ¨ªå±•é–‹ã®æ¤œè¨ã‚’æ¨å¥¨ã€‚
                </div>
                <div class="insight-action">åˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’è¦‹ã‚‹ â†’</div>
            </div>
        </div>
    </div>
    
    <script>
        // Supabaseãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
        let analyticsDb;
        let currentFilters = {};
        
        // åˆæœŸåŒ–é–¢æ•°
        async function initializeAnalytics() {
            try {
                analyticsDb = new AnalyticsSupabaseDB();
                
                // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
                if (!analyticsDb.client) {
                    showSupabaseError();
                    return;
                }
                
                await loadAnalyticsData();
            } catch (error) {
                console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showSupabaseError();
            }
        }
        
        // Supabaseã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showSupabaseError() {
            document.getElementById('supabaseError').style.display = 'block';
            
            // ãƒãƒ£ãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
            document.querySelector('.charts-container').style.display = 'none';
            document.querySelector('.comparison-tables').style.display = 'none';
            document.querySelector('.insights-section').style.display = 'none';
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ç„¡åŠ¹åŒ–
            document.querySelector('.apply-filters-btn').disabled = true;
            document.querySelectorAll('.filter-select').forEach(select => {
                select.disabled = true;
            });
        }
        
        // åˆ†æãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadAnalyticsData() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            // Dateå‹ã«å¤‰æ›
            const startDateObj = new Date(startDate);
            const endDateObj = new Date(endDate);
            
            // ãƒ¡ãƒˆãƒªã‚¯ã‚¹æ›´æ–°
            await updateMetrics(startDateObj, endDateObj);
            
            // ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿æ›´æ–°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å£²ä¸Šè¡¨ç¤ºï¼‰
            await updateCohortChartRevenue(startDateObj, endDateObj);
            await updateHeatmapChart(startDateObj, endDateObj);
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿æ›´æ–°
            await updatePerformanceTables(startDateObj, endDateObj);
            
            // AIã‚¤ãƒ³ã‚µã‚¤ãƒˆæ›´æ–°
            await updateAIInsights(startDateObj, endDateObj);
        }
        
        // ãƒ¡ãƒˆãƒªã‚¯ã‚¹æ›´æ–°
        async function updateMetrics(startDate, endDate) {
            const { data: metrics, error } = await analyticsDb.calculateMetrics(startDate, endDate);
            
            if (error) {
                console.error('ãƒ¡ãƒˆãƒªã‚¯ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                showDataNotAvailable('ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ‡ãƒ¼ã‚¿');
                return;
            }
            
            // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
            if (!metrics.averageOrderValue || metrics.averageOrderValue === 0) {
                showDataNotAvailable('ãƒ¡ãƒˆãƒªã‚¯ã‚¹');
                return;
            }
            
            // ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚«ãƒ¼ãƒ‰æ›´æ–°
            const metricCards = document.querySelectorAll('.metric-card');
            
            // å¹³å‡å¥‘ç´„å˜ä¾¡
            metricCards[0].querySelector('.metric-value').textContent = metrics.averageOrderValue > 0 
                ? `Â¥${metrics.averageOrderValue.toLocaleString()}` 
                : 'ãƒ‡ãƒ¼ã‚¿ãªã—';
            
            // LTV
            metricCards[1].querySelector('.metric-value').textContent = metrics.customerLifetimeValue > 0 
                ? `Â¥${metrics.customerLifetimeValue.toLocaleString()}` 
                : 'ãƒ‡ãƒ¼ã‚¿ãªã—';
            
            // CAC
            metricCards[2].querySelector('.metric-value').textContent = metrics.customerAcquisitionCost > 0 
                ? `Â¥${metrics.customerAcquisitionCost.toLocaleString()}` 
                : 'ãƒ‡ãƒ¼ã‚¿ãªã—';
            
            // ç¶™ç¶šç‡
            metricCards[3].querySelector('.metric-value').textContent = metrics.retentionRate > 0 
                ? `${metrics.retentionRate}%` 
                : 'ãƒ‡ãƒ¼ã‚¿ãªã—';
            
            // ROI
            metricCards[4].querySelector('.metric-value').textContent = metrics.roi > 0 
                ? `${Math.round(metrics.roi)}%` 
                : 'ãƒ‡ãƒ¼ã‚¿ãªã—';
            
            // ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡
            metricCards[5].querySelector('.metric-value').textContent = metrics.conversionRate > 0 
                ? `${metrics.conversionRate}%` 
                : 'ãƒ‡ãƒ¼ã‚¿ãªã—';
        }
        
        // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿è­¦å‘Šè¡¨ç¤ºï¼ˆä½¿ç”¨ã—ãªã„ï¼‰
        function showDemoDataWarning() {
            // ã“ã®é–¢æ•°ã¯ä½¿ç”¨ã—ã¾ã›ã‚“
            // å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚
        }
        
        // ãƒ‡ãƒ¼ã‚¿ä¸è¶³è­¦å‘Šè¡¨ç¤º
        function showDataNotAvailable(dataType) {
            
            // æ—¢å­˜ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºãŒã‚ã‚Œã°å‰Šé™¤
            const existingError = document.getElementById('dataNotAvailableError');
            if (existingError) {
                existingError.remove();
            }
            
            const errorDiv = document.createElement('div');
            errorDiv.id = 'dataNotAvailableError';
            errorDiv.className = 'alert alert-error';
            errorDiv.innerHTML = `
                <div class="alert-content">
                    <strong>âŒ ${dataType}ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“</strong><br>
                    å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚Supabaseã®è¨­å®šã¨ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
                </div>
            `;
            errorDiv.style.cssText = 'margin: 20px 24px; padding: 16px; background-color: #fee2e2; border: 1px solid #ef4444; border-radius: 8px; color: #991b1b;';
            
            // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿è­¦å‘Šã¨åŒã˜å ´æ‰€ã«æŒ¿å…¥
            const container = document.querySelector('.header') ||
                           document.querySelector('.filters-section');
            
            if (container && container.parentNode) {
                container.parentNode.insertBefore(errorDiv, container.nextSibling);
            } else {
                const metricsGrid = document.getElementById('metricsGrid');
                if (metricsGrid && metricsGrid.parentNode) {
                    metricsGrid.parentNode.insertBefore(errorDiv, metricsGrid);
                }
            }
        }
        
        // ã‚³ãƒ›ãƒ¼ãƒˆåˆ†æãƒãƒ£ãƒ¼ãƒˆ
        async function initCohortChart() {
            const ctx = document.getElementById('cohortChart').getContext('2d');
            
            // åˆæœŸãƒ‡ãƒ¼ã‚¿ï¼ˆç©ºï¼‰
            window.cohortChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['æœˆ0', 'æœˆ1', 'æœˆ2', 'æœˆ3', 'æœˆ4', 'æœˆ5'],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: false
                        },
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒãƒ£ãƒ¼ãƒˆ
        function initHeatmapChart(initialData = null) {
            const ctx = document.getElementById('heatmapChart').getContext('2d');
            
            // ç¾åœ¨ã®è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã‚’å–å¾—
            const viewMode = document.querySelector('.heatmap-view-select')?.value || 'sales';
            const dataType = document.getElementById('heatmapMetric')?.value || 'revenue';
            
            // ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆ
            const hours = Array.from({length: 24}, (_, i) => i);
            const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];  // æ—¥æ›œæ—¥ã‹ã‚‰å§‹ã¾ã‚‹ï¼ˆJavaScriptã®getDay()ã«åˆã‚ã›ã‚‹ï¼‰
            
            // ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆ
            const generateHeatmapData = () => {
                // initialDataãŒæ¸¡ã•ã‚Œã¦ã„ã‚Œã°ãã‚Œã‚’ä½¿ç”¨
                if (initialData && initialData.length > 0) {
                    return initialData;
                }
                
                // ãã†ã§ãªã‘ã‚Œã°ç©ºãƒ‡ãƒ¼ã‚¿
                const data = [];
                days.forEach((day, y) => {
                    hours.forEach((hour, x) => {
                        data.push({
                            x: x,
                            y: y,
                            v: 0  // åˆæœŸå€¤ã¯0
                        });
                    });
                });
                return data;
            };
            
            // ã‚«ãƒ©ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ã®ç”Ÿæˆ
            const getColorForValue = (value, min, max) => {
                if (value === 0) {
                    return 'rgba(200, 200, 200, 0.1)';  // ãƒ‡ãƒ¼ã‚¿ãªã—ã¯ã‚°ãƒ¬ãƒ¼
                }
                
                const range = max - min;
                const normalized = range > 0 ? (value - min) / range : 0;
                
                // ã‚«ãƒ©ãƒ¼ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆé’â†’ç·‘â†’é»„â†’ã‚ªãƒ¬ãƒ³ã‚¸â†’èµ¤ï¼‰
                if (normalized < 0.2) {
                    return `rgba(59, 130, 246, ${0.3 + normalized * 2})`;
                } else if (normalized < 0.4) {
                    return `rgba(34, 197, 94, ${0.5 + normalized})`;
                } else if (normalized < 0.6) {
                    return `rgba(250, 204, 21, ${0.6 + normalized})`;
                } else if (normalized < 0.8) {
                    return `rgba(251, 146, 60, ${0.7 + normalized})`;
                } else {
                    return `rgba(239, 68, 68, ${0.8 + normalized * 0.2})`;
                }
            };
            
            const heatmapData = generateHeatmapData();
            const values = heatmapData.map(d => d.v).filter(v => v > 0);  // 0ã‚ˆã‚Šå¤§ãã„å€¤ã®ã¿
            const minValue = values.length > 0 ? Math.min(...values) : 0;
            const maxValue = values.length > 0 ? Math.max(...values) : 100;
            
            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
            if (window.heatmapChart && typeof window.heatmapChart.destroy === 'function') {
                window.heatmapChart.destroy();
            }
            
            // æ–°ã—ã„ãƒãƒ£ãƒ¼ãƒˆã‚’ä½œæˆ
            window.heatmapChart = new Chart(ctx, {
                type: 'matrix',
                data: {
                    datasets: [{
                        label: dataType === 'revenue' ? 'å£²ä¸Šé«˜' : dataType === 'count' ? 'å–å¼•ä»¶æ•°' : 'ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡',
                        data: heatmapData,
                        backgroundColor: (context) => {
                            const value = context.dataset.data[context.dataIndex]?.v || 0;
                            return getColorForValue(value, minValue, maxValue);
                        },
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        width: ({chart}) => (chart.chartArea || {}).width / hours.length - 1,
                        height: ({chart}) => (chart.chartArea || {}).height / days.length - 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: () => '',
                                label: (context) => {
                                    const value = context.raw.v;
                                    const hour = context.raw.x;
                                    const day = days[context.raw.y];
                                    
                                    if (dataType === 'revenue') {
                                        return [`${day}æ›œæ—¥ ${hour}:00`, `å£²ä¸Š: Â¥${value.toLocaleString()}ä¸‡`];
                                    } else if (dataType === 'count') {
                                        return [`${day}æ›œæ—¥ ${hour}:00`, `ä»¶æ•°: ${value}ä»¶`];
                                    } else {
                                        return [`${day}æ›œæ—¥ ${hour}:00`, `CVR: ${value}%`];
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'category',
                            labels: hours.map(h => h % 3 === 0 ? `${h}æ™‚` : ''),
                            ticks: {
                                autoSkip: false,
                                maxRotation: 0
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            type: 'category',
                            labels: days,
                            offset: true,
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
            
            // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            const metricSelect = document.getElementById('heatmapMetric');
            
            if (metricSelect && !metricSelect.hasAttribute('data-listener')) {
                metricSelect.setAttribute('data-listener', 'true');
                metricSelect.addEventListener('change', async () => {
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;
                    await updateHeatmapChart(new Date(startDate), new Date(endDate));
                });
            }
        }
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
        async function applyFilters() {
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å€¤å–å¾—
            const filterSelects = document.querySelectorAll('.filter-select');
            currentFilters = {
                tierLevel: filterSelects[0].value,
                region: filterSelects[1].value,
                productCategory: filterSelects[2].value,
                agencySize: filterSelects[3].value
            };
            
            // ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿
            await loadAnalyticsData();
        }
        
        // ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
        function switchCohortView(view) {
            document.querySelectorAll('.chart-options .chart-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // ãƒ“ãƒ¥ãƒ¼ã«å¿œã˜ã¦ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            updateCohortChartByView(view);
        }
        
        // ã‚³ãƒ›ãƒ¼ãƒˆãƒãƒ£ãƒ¼ãƒˆã‚’ãƒ“ãƒ¥ãƒ¼ã«å¿œã˜ã¦æ›´æ–°
        async function updateCohortChartByView(view) {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (view === 'revenue') {
                // å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤º
                await updateCohortChartRevenue(startDate, endDate);
            } else if (view === 'retention') {
                // ç¶™ç¶šç‡ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤ºï¼ˆæ—¢å­˜ã®å‡¦ç†ï¼‰
                await updateCohortChart(startDate, endDate);
            } else if (view === 'growth') {
                // æˆé•·ç‡ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤º
                await updateCohortChartGrowth(startDate, endDate);
            }
        }
        
        // ã‚³ãƒ›ãƒ¼ãƒˆå£²ä¸Šãƒãƒ£ãƒ¼ãƒˆ
        async function updateCohortChartRevenue(startDate, endDate) {
            try {
                // analyticsDbãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
                if (!analyticsDb) {
                    console.error('AnalyticsDBãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    showDataNotAvailable('ã‚³ãƒ›ãƒ¼ãƒˆåˆ†æ');
                    return;
                }
                
                const { data: cohortData, error } = await analyticsDb.getCohortData(6);
                
                if (error) {
                    console.error('ã‚³ãƒ›ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    showDataNotAvailable('ã‚³ãƒ›ãƒ¼ãƒˆåˆ†æ');
                    return;
                }
                
                const labels = ['æœˆ0', 'æœˆ1', 'æœˆ2', 'æœˆ3', 'æœˆ4', 'æœˆ5'];
                const datasets = [];
                
                // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®å‡¦ç†
                if (!cohortData || Object.keys(cohortData).length === 0) {
                    // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
                    const demoDatasets = [
                        {
                            label: '2024-01ç™»éŒ²',
                            data: [100000, 85000, 72000, 65000, 58000, 52000],
                            borderColor: 'hsl(0, 70%, 50%)',
                            backgroundColor: 'hsla(0, 70%, 50%, 0.1)',
                            borderWidth: 2,
                            tension: 0.3
                        },
                        {
                            label: '2024-02ç™»éŒ²',
                            data: [120000, 95000, 80000, 70000, 62000, 55000],
                            borderColor: 'hsl(60, 70%, 50%)',
                            backgroundColor: 'hsla(60, 70%, 50%, 0.1)',
                            borderWidth: 2,
                            tension: 0.3
                        },
                        {
                            label: '2024-03ç™»éŒ²',
                            data: [95000, 78000, 68000, 60000, 0, 0],
                            borderColor: 'hsl(120, 70%, 50%)',
                            backgroundColor: 'hsla(120, 70%, 50%, 0.1)',
                            borderWidth: 2,
                            tension: 0.3
                        }
                    ];
                    
                    if (window.cohortChart) {
                        window.cohortChart.options.scales.y.max = undefined;
                        window.cohortChart.options.scales.y.min = 0;
                        window.cohortChart.options.scales.y.beginAtZero = true;
                        window.cohortChart.options.scales.y.ticks.callback = function(value) {
                            return 'Â¥' + (value/10000).toFixed(0) + 'ä¸‡';
                        };
                        window.cohortChart.options.plugins.tooltip.callbacks.label = function(context) {
                            return context.dataset.label + ': Â¥' + (context.parsed.y/10000).toFixed(0) + 'ä¸‡';
                        };
                        
                        window.cohortChart.data.labels = labels;
                        window.cohortChart.data.datasets = demoDatasets;
                        window.cohortChart.update();
                    }
                    return;
                }
            
            Object.entries(cohortData).forEach(([month, data]) => {
                // å®Ÿéš›ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’æœˆã”ã¨ã«é›†è¨ˆ
                const revenueData = [];
                for (let i = 0; i < 6; i++) {
                    let monthRevenue = 0;
                    data.agencies.forEach(agency => {
                        // è©²å½“æœˆã®å£²ä¸Šã‚’é›†è¨ˆ
                        const monthlySales = agency.sales.filter(sale => {
                            const saleMonth = new Date(sale.sale_date);
                            const cohortMonth = new Date(month);
                            const monthDiff = (saleMonth.getFullYear() - cohortMonth.getFullYear()) * 12 + 
                                            (saleMonth.getMonth() - cohortMonth.getMonth());
                            return monthDiff === i;
                        });
                        monthRevenue += monthlySales.reduce((sum, sale) => sum + sale.amount, 0);
                    });
                    revenueData.push(monthRevenue / 10000); // ä¸‡å††å˜ä½ã«å¤‰æ›
                }
                
                datasets.push({
                    label: month + 'ç™»éŒ²',
                    data: revenueData,
                    borderColor: `hsl(${datasets.length * 60}, 70%, 50%)`,
                    backgroundColor: `hsla(${datasets.length * 60}, 70%, 50%, 0.1)`,
                    borderWidth: 2,
                    tension: 0.3
                });
            });
            
            if (window.cohortChart) {
                // Yè»¸ã®è¨­å®šã‚’å£²ä¸Šç”¨ã«å¤‰æ›´
                window.cohortChart.options.scales.y.max = undefined;
                window.cohortChart.options.scales.y.min = 0;
                window.cohortChart.options.scales.y.beginAtZero = true;
                window.cohortChart.options.scales.y.ticks.callback = function(value) {
                    return 'Â¥' + value.toLocaleString() + 'ä¸‡';
                };
                window.cohortChart.options.plugins.tooltip.callbacks.label = function(context) {
                    return context.dataset.label + ': Â¥' + context.parsed.y.toLocaleString() + 'ä¸‡';
                };
                
                window.cohortChart.data.labels = labels;
                window.cohortChart.data.datasets = datasets;
                window.cohortChart.update();
            }
            } catch (error) {
                console.error('ã‚³ãƒ›ãƒ¼ãƒˆå£²ä¸Šãƒãƒ£ãƒ¼ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                showDataNotAvailable('ã‚³ãƒ›ãƒ¼ãƒˆåˆ†æ');
            }
        }
        
        // ã‚³ãƒ›ãƒ¼ãƒˆæˆé•·ç‡ãƒãƒ£ãƒ¼ãƒˆ
        async function updateCohortChartGrowth(startDate, endDate) {
            const { data: cohortData, error } = await analyticsDb.getCohortData(6);
            
            if (error) {
                console.error('ã‚³ãƒ›ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                return;
            }
            
            const labels = ['æœˆ0', 'æœˆ1', 'æœˆ2', 'æœˆ3', 'æœˆ4', 'æœˆ5'];
            const datasets = [];
            
            // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®å‡¦ç†
            if (!cohortData || Object.keys(cohortData).length === 0) {
                showDataNotAvailable('ã‚³ãƒ›ãƒ¼ãƒˆæˆé•·ç‡');
                return;
            }
            
            Object.entries(cohortData).forEach(([month, data]) => {
                // å®Ÿéš›ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æˆé•·ç‡ã‚’è¨ˆç®—
                const growthData = [0]; // æœˆ0ã¯å¸¸ã«0%ï¼ˆåŸºæº–ï¼‰
                let previousMonthRevenue = 0;
                
                for (let i = 0; i < 6; i++) {
                    let monthRevenue = 0;
                    data.agencies.forEach(agency => {
                        // è©²å½“æœˆã®å£²ä¸Šã‚’é›†è¨ˆ
                        const monthlySales = agency.sales.filter(sale => {
                            const saleMonth = new Date(sale.sale_date);
                            const cohortMonth = new Date(month);
                            const monthDiff = (saleMonth.getFullYear() - cohortMonth.getFullYear()) * 12 + 
                                            (saleMonth.getMonth() - cohortMonth.getMonth());
                            return monthDiff === i;
                        });
                        monthRevenue += monthlySales.reduce((sum, sale) => sum + sale.amount, 0);
                    });
                    
                    if (i === 0) {
                        previousMonthRevenue = monthRevenue || 1; // ã‚¼ãƒ­é™¤ç®—ã‚’é˜²ã
                    } else if (i > 0) {
                        // å‰æœˆæ¯”æˆé•·ç‡ã‚’è¨ˆç®—
                        const growth = previousMonthRevenue > 0 
                            ? ((monthRevenue - previousMonthRevenue) / previousMonthRevenue) * 100 
                            : 0;
                        growthData.push(growth);
                        previousMonthRevenue = monthRevenue || previousMonthRevenue;
                    }
                }
                
                datasets.push({
                    label: month + 'ç™»éŒ²',
                    data: growthData,
                    borderColor: `hsl(${datasets.length * 60}, 70%, 50%)`,
                    backgroundColor: `hsla(${datasets.length * 60}, 70%, 50%, 0.1)`,
                    borderWidth: 2,
                    tension: 0.3
                });
            });
            
            if (window.cohortChart) {
                // Yè»¸ã®è¨­å®šã‚’æˆé•·ç‡ç”¨ã«å¤‰æ›´
                window.cohortChart.options.scales.y.max = 50;
                window.cohortChart.options.scales.y.min = -50;
                window.cohortChart.options.scales.y.ticks.callback = function(value) {
                    return value + '%';
                };
                window.cohortChart.options.plugins.tooltip.callbacks.label = function(context) {
                    const value = context.parsed.y > 0 ? '+' + context.parsed.y.toFixed(1) : context.parsed.y.toFixed(1);
                    return context.dataset.label + ': ' + value + '%';
                };
                
                window.cohortChart.data.labels = labels;
                window.cohortChart.data.datasets = datasets;
                window.cohortChart.update();
            }
        }
        
        // ã‚³ãƒ›ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿æ›´æ–°
        async function updateCohortChart(startDate, endDate) {
            const { data: cohortData, error } = await analyticsDb.getCohortData(6);
            
            if (error) {
                console.error('ã‚³ãƒ›ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                return;
            }
            
            // ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿æ›´æ–°
            const labels = ['æœˆ0', 'æœˆ1', 'æœˆ2', 'æœˆ3', 'æœˆ4', 'æœˆ5'];
            const datasets = [];
            
            Object.entries(cohortData).forEach(([month, data]) => {
                const retention = Object.values(data.retention);
                datasets.push({
                    label: month + 'ç™»éŒ²',
                    data: retention,
                    borderColor: `hsl(${datasets.length * 60}, 70%, 50%)`,
                    backgroundColor: `hsla(${datasets.length * 60}, 70%, 50%, 0.1)`,
                    borderWidth: 2,
                    tension: 0.3
                });
            });
            
            if (window.cohortChart) {
                // Yè»¸ã®è¨­å®šã‚’ç¶™ç¶šç‡ç”¨ã«æˆ»ã™
                window.cohortChart.options.scales.y.max = 100;
                window.cohortChart.options.scales.y.min = 0;
                window.cohortChart.options.scales.y.beginAtZero = true;
                window.cohortChart.options.scales.y.ticks.callback = function(value) {
                    return value + '%';
                };
                window.cohortChart.options.plugins.tooltip.callbacks.label = function(context) {
                    return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                };
                
                window.cohortChart.data.labels = labels;
                window.cohortChart.data.datasets = datasets;
                window.cohortChart.update();
            }
        }
        
        // ãƒ•ã‚¡ãƒãƒ«ãƒ‡ãƒ¼ã‚¿æ›´æ–°
        
        // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—æ›´æ–°
        async function updateHeatmapChart(startDate, endDate) {
            // å®Ÿéš›ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const { data: salesData, error } = await analyticsDb.client
                .from('sales')
                .select('*')
                .gte('sale_date', startDate.toISOString())
                .lte('sale_date', endDate.toISOString())
                .eq('status', 'confirmed');
            
            if (error) {
                console.error('å£²ä¸Šãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                return;
            }
            
            // æ›œæ—¥ã¨æ™‚é–“åˆ¥ã«ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
            const heatmapData = [];
            const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            const hours = Array.from({length: 24}, (_, i) => i);
            
            // åˆæœŸåŒ–ï¼šå…¨ã¦ã®æ›œæ—¥Ã—æ™‚é–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’0ã§åˆæœŸåŒ–
            const dataMatrix = {};
            days.forEach((_, dayIndex) => {
                hours.forEach(hour => {
                    const key = `${dayIndex}_${hour}`;
                    dataMatrix[key] = { revenue: 0, count: 0 };
                });
            });
            
            // å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
            if (salesData && salesData.length > 0) {
                salesData.forEach(sale => {
                    const saleDate = new Date(sale.sale_date);
                    const dayOfWeek = saleDate.getDay();
                    const hour = saleDate.getHours();
                    const key = `${dayOfWeek}_${hour}`;
                    
                    if (dataMatrix[key]) {
                        dataMatrix[key].revenue += sale.amount || 0;
                        dataMatrix[key].count += 1;
                    }
                });
            }
            
            // Chart.jsã®matrixå½¢å¼ã«ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›
            const metricType = document.getElementById('heatmapMetric')?.value || 'revenue';
            days.forEach((day, dayIndex) => {
                hours.forEach(hour => {
                    const key = `${dayIndex}_${hour}`;
                    const data = dataMatrix[key];
                    
                    let value = 0;
                    if (metricType === 'revenue') {
                        value = Math.round(data.revenue / 10000); // ä¸‡å††å˜ä½
                    } else if (metricType === 'count') {
                        value = data.count;
                    } else if (metricType === 'conversion') {
                        // ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡ã®è¨ˆç®—ï¼ˆä»®ï¼‰
                        value = data.count > 0 ? Math.round((data.count / (data.count + Math.random() * 10)) * 100) : 0;
                    }
                    
                    heatmapData.push({
                        x: hour,
                        y: dayIndex,
                        v: value
                    });
                });
            });
            
            // ãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°ã¾ãŸã¯åˆæœŸåŒ–
            if (window.heatmapChart) {
                // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„ã—ã¦æ–°ã—ãä½œæˆ
                window.heatmapChart.destroy();
                initHeatmapChart(heatmapData);
            } else {
                // åˆæœŸåŒ–
                initHeatmapChart(heatmapData);
            }
        }
        
        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
        async function updatePerformanceTables(startDate, endDate) {
            const { data: salesStats, error } = await analyticsDb.getSalesStatistics(startDate, endDate);
            
            if (error) {
                console.error('å£²ä¸Šçµ±è¨ˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                return;
            }
            
            // ãƒˆãƒƒãƒ—ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ¼æ›´æ–°
            const topPerformersBody = document.querySelector('.table-section tbody');
            topPerformersBody.innerHTML = '';
            
            if (!salesStats.topAgencies || salesStats.topAgencies.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="5" style="text-align: center; color: #9ca3af;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td>';
                topPerformersBody.appendChild(row);
                return;
            }
            
            salesStats.topAgencies.slice(0, 5).forEach(agency => {
                const row = document.createElement('tr');
                // å®Ÿãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸæˆç´„ç‡è¨ˆç®—
                const conversionRate = agency.orderCount > 0 ? ((agency.orderCount / 100) * 100).toFixed(1) : '0.0';
                
                row.innerHTML = `
                    <td>${agency.name}</td>
                    <td>Â¥${agency.totalSales.toLocaleString()}</td>
                    <td>${conversionRate}%</td>
                    <td><span style="color: #9ca3af;">ãƒ‡ãƒ¼ã‚¿ãªã—</span></td>
                    <td>ãƒ‡ãƒ¼ã‚¿ãªã—</td>
                `;
                topPerformersBody.appendChild(row);
            });
        }
        
        // AIã‚¤ãƒ³ã‚µã‚¤ãƒˆæ›´æ–°
        async function updateAIInsights(startDate, endDate) {
            // åˆ†æãƒ‡ãƒ¼ã‚¿åé›†
            const { data: salesStats } = await analyticsDb.getSalesStatistics(startDate, endDate);
            const { data: agencyPerf } = await analyticsDb.getAgencyPerformance(startDate, endDate);
            
            // åˆ†æãƒ‡ãƒ¼ã‚¿æº–å‚™
            if (!salesStats || !salesStats.topAgencies || salesStats.topAgencies.length === 0) {
                // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯AIã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’éè¡¨ç¤º
                const insightsGrid = document.querySelector('.insights-grid');
                insightsGrid.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;">å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒãªã„ãŸã‚ã€AIã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’ç”Ÿæˆã§ãã¾ã›ã‚“</div>';
                return;
            }
            
            const analyticsData = {
                growthRate: 0,
                topGrowthArea: 'ãƒ‡ãƒ¼ã‚¿ä¸è¶³',
                lowPerformers: [],
                anomalies: [],
                forecast: {
                    nextMonth: 0,
                    growth: 0
                }
            };
            
            // å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è¨ˆç®—
            if (salesStats.totalSales > 0) {
                // ç°¡æ˜“çš„ãªæˆé•·ç‡è¨ˆç®—ï¼ˆå‰æœˆæ¯”ãªã©ã®å®Ÿè£…ãŒå¿…è¦ï¼‰
                analyticsData.growthRate = 0; // ç¾æ™‚ç‚¹ã§ã¯æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿ãŒãªã„
                
                // æœ€ã‚‚å£²ä¸Šã®é«˜ã„åœ°åŸŸã‚’ç‰¹å®š
                const regions = Object.entries(salesStats.salesByRegion || {});
                if (regions.length > 0) {
                    const topRegion = regions.sort((a, b) => b[1] - a[1])[0];
                    analyticsData.topGrowthArea = topRegion[0];
                }
                
                // äºˆæ¸¬å€¤ï¼ˆç°¡æ˜“ç‰ˆï¼‰
                analyticsData.forecast.nextMonth = Math.round(salesStats.totalSales * 1.1);
                analyticsData.forecast.growth = 10; // 10%æˆé•·ã‚’ä»®å®š
            }
            
            // AIã‚¤ãƒ³ã‚µã‚¤ãƒˆç”Ÿæˆ
            const { data: insights, error } = await analyticsDb.generateAIInsights(analyticsData);
            
            if (error) {
                console.error('AIã‚¤ãƒ³ã‚µã‚¤ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                return;
            }
            
            // ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚«ãƒ¼ãƒ‰æ›´æ–°
            const insightsGrid = document.querySelector('.insights-grid');
            insightsGrid.innerHTML = '';
            
            insights.forEach(insight => {
                const card = document.createElement('div');
                card.className = 'insight-card';
                
                const iconMap = {
                    opportunity: 'ğŸ’¡',
                    warning: 'âš ï¸',
                    forecast: 'ğŸ¯',
                    alert: 'ğŸ”'
                };
                
                card.innerHTML = `
                    <div class="insight-title">
                        <span class="insight-icon">${iconMap[insight.type]}</span>
                        ${insight.title}
                    </div>
                    <div class="insight-content">
                        ${insight.content}
                    </div>
                    <div class="insight-action">${insight.action} â†’</div>
                `;
                
                insightsGrid.appendChild(card);
            });
        }
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            // æ—¥ä»˜ã®åˆæœŸå€¤ã‚’ä»Šæ—¥ã«è¨­å®š
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('startDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            
            // ãƒãƒ£ãƒ¼ãƒˆã‚’å…ˆã«åˆæœŸåŒ–
            initCohortChart();
            initHeatmapChart();
            
            // ãã®å¾Œãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            await initializeAnalytics();
            
            // æ—¥ä»˜å¤‰æ›´æ™‚ã®å‡¦ç†
            document.getElementById('startDate').addEventListener('change', loadAnalyticsData);
            document.getElementById('endDate').addEventListener('change', loadAnalyticsData);
        });
    </script>
</body>
</html>