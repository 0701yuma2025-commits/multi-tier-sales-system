<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>報酬データ作成</title>
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- 共通スクリプト -->
    <script src="js/supabase-config.js"></script>
    <script src="js/commissions-supabase.js"></script>
</head>
<body>
    <h1>Supabase報酬データ作成ツール</h1>
    <button onclick="createCommissionData()">2024年3月の報酬データを作成</button>
    <div id="result"></div>
    
    <script>
        // ページ読み込み後に初期化確認
        window.addEventListener('DOMContentLoaded', function() {
            console.log('Supabase:', typeof window.supabase);
            console.log('SUPABASE_CONFIG:', typeof SUPABASE_CONFIG);
            console.log('initializeSupabase:', typeof initializeSupabase);
            console.log('CommissionsSupabaseDB:', typeof CommissionsSupabaseDB);
        });
        
        async function createCommissionData() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p>処理中...</p>';
            
            try {
                // 必要な関数が存在するか確認
                if (typeof initializeSupabase === 'undefined') {
                    throw new Error('initializeSupabase関数が定義されていません');
                }
                if (typeof CommissionsSupabaseDB === 'undefined') {
                    throw new Error('CommissionsSupabaseDBクラスが定義されていません');
                }
                
                const commissionsDb = new CommissionsSupabaseDB();
            
            try {
                // 売上データを作成（仮想的に）
                const agencies = await commissionsDb.client
                    .from('agencies')
                    .select('*')
                    .eq('status', 'active');
                
                console.log('アクティブな代理店:', agencies.data);
                
                if (!agencies.data || agencies.data.length === 0) {
                    resultDiv.innerHTML = '<p style="color: red;">アクティブな代理店が見つかりません。先に代理店を承認してください。</p>';
                    return;
                }
                
                // 各代理店の報酬を作成
                for (const agency of agencies.data) {
                    // ランダムな売上を生成
                    const salesAmount = Math.floor(Math.random() * 500000) + 100000;
                    const commission = commissionsDb.calculateAgencyCommission(agency, salesAmount, '2024-03');
                    
                    console.log('作成する報酬データ:', commission);
                    
                    const { data, error } = await commissionsDb.upsertCommission(commission);
                    
                    if (error) {
                        console.error('報酬作成エラー:', error);
                        resultDiv.innerHTML += `<p style="color: red;">${agency.company_name}: エラー - ${error.message}</p>`;
                    } else {
                        console.log('報酬作成成功:', data);
                        resultDiv.innerHTML += `<p style="color: green;">${agency.company_name}: 売上 ¥${salesAmount.toLocaleString()} → 報酬 ¥${commission.total_commission.toLocaleString()}</p>`;
                    }
                }
                
                // 作成後の確認
                const { data: allCommissions } = await commissionsDb.getCommissions('2024-03');
                console.log('全報酬データ:', allCommissions);
                
                resultDiv.innerHTML += '<h2>作成完了</h2>';
                resultDiv.innerHTML += `<p>作成された報酬件数: ${allCommissions?.length || 0}件</p>`;
                resultDiv.innerHTML += '<p><a href="commissions-admin.html">報酬管理画面に戻る</a></p>';
                
            } catch (error) {
                console.error('エラー:', error);
                resultDiv.innerHTML = `<p style="color: red;">エラー: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>